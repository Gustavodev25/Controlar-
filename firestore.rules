rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Verifica se o usuario atual e admin
    function isUserAdmin() {
      let userDoc = request.auth != null
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;

      return (
        // Permite tanto custom claims quanto campos no documento
        request.auth != null && (
          request.auth.token.admin == true ||
          request.auth.token.isAdmin == true
        ) ||
        userDoc != null && (
          userDoc.data.profile.isAdmin == true ||  // Admin salvo dentro de profile
          userDoc.data.isAdmin == true             // Fallback para admin na raiz
        )
      );
    }

    // Regras para Usuarios: Dono ou Admin
    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }
    
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }

    // Regras para Familias
    match /families/{familyId} {
      // Leitura: Membro, Dono ou Admin
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.members.hasAny([request.auth.uid]) ||
        isUserAdmin()
      );

      // Criacao: Qualquer um
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;

      // Atualizacao: Membro, Dono ou Admin
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.members.hasAny([request.auth.uid]) ||
        isUserAdmin()
      );
    }

    // Regras para Lista de Espera
    match /waitlist/{document} {
      allow create: if true;  // Qualquer pessoa pode se cadastrar
      allow read, update, delete: if request.auth != null && isUserAdmin();  // Apenas admins autenticados
    }
  }
}
