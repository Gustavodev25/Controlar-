rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isUserAdmin() {
      let userDoc = request.auth != null
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;

      return (
        request.auth != null && (
          request.auth.token.admin == true ||
          request.auth.token.isAdmin == true
        ) ||
        userDoc != null && (
          userDoc.data.profile.isAdmin == true ||
          userDoc.data.isAdmin == true
        )
      );
    }

    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }
    
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }

    match /families/{familyId} {
      // Permitir leitura para qualquer usuário autenticado (para carregar convites)
      allow read: if request.auth != null;

      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;

      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.members.hasAny([request.auth.uid]) ||
        isUserAdmin() ||
        // Permitir entrar na família (Join):
        // 1. Usuário ainda não é membro
        // 2. Usuário está se adicionando na lista
        // 3. Lista aumentou em exatamente 1 (evita deletar outros)
        (
          !resource.data.members.hasAny([request.auth.uid]) &&
          request.resource.data.members.hasAny([request.auth.uid]) &&
          request.resource.data.members.size() == resource.data.members.size() + 1
        )
      );
    }

    // Regras para subcoleções da família (goals, etc.)
    match /families/{familyId}/goals/{goalId} {
      // Função auxiliar para verificar se o usuário é membro da família
      function isFamilyMember() {
        let family = get(/databases/$(database)/documents/families/$(familyId));
        return family != null && (
          family.data.ownerId == request.auth.uid ||
          family.data.members.hasAny([request.auth.uid])
        );
      }

      // Permitir leitura e escrita para membros da família ou admins
      allow read, write: if request.auth != null && (isFamilyMember() || isUserAdmin());
    }

    match /waitlist/{document} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && isUserAdmin();
    }

    // Regras para cupons de desconto
    match /coupons/{couponId} {
      // Admins podem fazer tudo
      allow read, write: if request.auth != null && isUserAdmin();
      // Usuários autenticados podem apenas ler (para validar no checkout)
      allow read: if request.auth != null;
    }
  }
}
