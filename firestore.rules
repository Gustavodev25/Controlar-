rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isUserAdmin() {
      let userDoc = request.auth != null
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;

      return (
        request.auth != null && (
          request.auth.token.admin == true ||
          request.auth.token.isAdmin == true
        ) ||
        userDoc != null && (
          userDoc.data.profile.isAdmin == true ||
          userDoc.data.isAdmin == true
        )
      );
    }

    match /users/{userId} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }

    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && (request.auth.uid == userId || isUserAdmin());
    }

    match /families/{familyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.members.hasAny([request.auth.uid]) ||
        isUserAdmin() ||
        (
          !resource.data.members.hasAny([request.auth.uid]) &&
          request.resource.data.members.hasAny([request.auth.uid]) &&
          request.resource.data.members.size() == resource.data.members.size() + 1
        )
      );
    }

    match /families/{familyId}/goals/{goalId} {
      function isFamilyMember() {
        let family = get(/databases/$(database)/documents/families/$(familyId));
        return family != null && (
          family.data.ownerId == request.auth.uid ||
          family.data.members.hasAny([request.auth.uid])
        );
      }
      allow read, write: if request.auth != null && (isFamilyMember() || isUserAdmin());
    }

    match /waitlist/{document} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && isUserAdmin();
    }

    // --- REGRAS DE CUPONS ---
    // Leitura: Permitida para todos os usuários autenticados (para validar na hora do checkout)
    // Escrita/Criação: Apenas Admins podem criar ou alterar propriedades do cupom
    // Atualização de Uso (currentUses): Permitimos que QUALQUER usuário autenticado incremente o contador
    // desde que seja a única mudança feita no documento (segurança via regras).
    match /coupons/{couponId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && isUserAdmin();
      allow update: if request.auth != null && (
        isUserAdmin() || 
        (
          // Permite usuários comuns atualizarem APENAS o campo 'currentUses'
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentUses']) &&
          request.resource.data.currentUses == resource.data.currentUses + 1
        )
      );
    }

    // --- NOVA REGRA PARA O CONTADOR ---
    match /system_stats/{statId} {
      allow read, write: if request.auth != null;
    }

    // --- REGRAS PARA CONFIGURAÇÕES DO SISTEMA (PIXELS, ETC) ---
    match /system/{document=**} {
      allow read: if true;
      allow write: if request.auth != null && isUserAdmin();
    }
  }
}