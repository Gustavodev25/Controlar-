---
description: Fluxo completo da Auto SincronizaÃ§Ã£o Pluggy para obter e salvar dados
---

# ğŸ”„ Fluxo de Auto SincronizaÃ§Ã£o Pluggy

## VisÃ£o Geral do Sistema

O sistema possui **3 formas de gatilho** para sincronizaÃ§Ã£o automÃ¡tica com o Pluggy:

---

## ğŸ“Š DIAGRAMA DO FLUXO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ¯ GATILHOS DE SINCRONIZAÃ‡ÃƒO                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ â° CRON JOB       â”‚  â”‚ ğŸ“¡ WEBHOOK        â”‚  â”‚ ğŸ”„ TRIGGER MANUAL â”‚          â”‚
â”‚   â”‚                   â”‚  â”‚                   â”‚  â”‚                   â”‚          â”‚
â”‚   â”‚ Vercel Cron       â”‚  â”‚ Pluggy envia      â”‚  â”‚ UsuÃ¡rio clica     â”‚          â”‚
â”‚   â”‚ 00:00 BRT diÃ¡rio  â”‚  â”‚ eventos ao        â”‚  â”‚ "Sincronizar"     â”‚          â”‚
â”‚   â”‚                   â”‚  â”‚ nosso server      â”‚  â”‚ no app            â”‚          â”‚
â”‚   â”‚ api/cron-sync.js  â”‚  â”‚                   â”‚  â”‚                   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                      â”‚                      â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                   â”‚                                             â”‚
â”‚                                   â–¼                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ–¥ï¸ BACKEND (Express/Vercel)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  ğŸ“ api/pluggy.js                                                     â”‚     â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  ğŸ”‘ getPluggyApiKey()                                                 â”‚     â”‚
â”‚   â”‚  â””â”€ Gera/Cache token de autenticaÃ§Ã£o (TTL: 10min)                    â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  ğŸ“¨ POST /webhook  â† Recebe eventos do Pluggy                        â”‚     â”‚
â”‚   â”‚  â””â”€ item/updated, transactions/created, transactions/deleted         â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  ğŸ”„ syncItem(apiKey, itemId, userId)                                  â”‚     â”‚
â”‚   â”‚  â””â”€ Orquestra toda a sincronizaÃ§Ã£o de um item                        â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  ğŸ“ api/cron-sync.js (SincronizaÃ§Ã£o Agendada)                         â”‚     â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â”‚  1ï¸âƒ£  Inicializa Firebase Admin                                        â”‚     â”‚
â”‚   â”‚  2ï¸âƒ£  Busca todos os usuÃ¡rios do Firestore                            â”‚     â”‚
â”‚   â”‚  3ï¸âƒ£  Para cada usuÃ¡rio com contas AUTO:                              â”‚     â”‚
â”‚   â”‚      â””â”€ syncUserAccounts(db, userId, accounts, apiKey)                â”‚     â”‚
â”‚   â”‚  4ï¸âƒ£  Envia notificaÃ§Ã£o de conclusÃ£o                                  â”‚     â”‚
â”‚   â”‚                                                                       â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ğŸ”— PLUGGY API (api.pluggy.ai)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  ğŸ” POST /auth      â”‚  â”‚  ğŸ“‹ GET /accounts   â”‚  â”‚  ğŸ’³ GET /bills      â”‚    â”‚
â”‚   â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚    â”‚
â”‚   â”‚  AutenticaÃ§Ã£o       â”‚  â”‚  Lista contas do    â”‚  â”‚  Faturas de cartÃ£o  â”‚    â”‚
â”‚   â”‚  Client ID/Secret   â”‚  â”‚  item conectado     â”‚  â”‚  de crÃ©dito         â”‚    â”‚
â”‚   â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚    â”‚
â”‚   â”‚  â†’ Retorna apiKey   â”‚  â”‚  â†’ Retorna array    â”‚  â”‚  â†’ Retorna array    â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  ğŸ’° GET /transactionsâ”‚  â”‚  ğŸ“Š GET /items     â”‚  â”‚  ğŸ—‘ï¸ PATCH /items   â”‚    â”‚
â”‚   â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚    â”‚
â”‚   â”‚  TransaÃ§Ãµes da      â”‚  â”‚  Lista conexÃµes     â”‚  â”‚  ForÃ§a atualizaÃ§Ã£o  â”‚    â”‚
â”‚   â”‚  conta bancÃ¡ria     â”‚  â”‚  do usuÃ¡rio         â”‚  â”‚  dos dados          â”‚    â”‚
â”‚   â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚    â”‚
â”‚   â”‚  â†’ Retorna array    â”‚  â”‚  â†’ Retorna array    â”‚  â”‚  â†’ Dispara sync     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ”¥ FIREBASE FIRESTORE (PersistÃªncia)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   ğŸ“ users/{userId}/                                                            â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â”œâ”€â”€ ğŸ“Š accounts/                   â† Contas conectadas (checking, savings)    â”‚
â”‚   â”‚   â””â”€â”€ {accountId}: { id, itemId, name, balance, type, lastUpdated, ... }    â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â”œâ”€â”€ ğŸ¦ connectedAccounts/          â† CartÃµes de crÃ©dito conectados            â”‚
â”‚   â”‚   â””â”€â”€ {accountId}: { id, itemId, creditLimit, closingDay, bills, ... }      â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â”œâ”€â”€ ğŸ’° transactions/               â† TransaÃ§Ãµes de conta corrente/poupanÃ§a    â”‚
â”‚   â”‚   â””â”€â”€ {txId}: { date, amount, category, providerId, importSource, ... }     â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â”œâ”€â”€ ğŸ’³ creditCardTransactions/     â† TransaÃ§Ãµes de cartÃ£o de crÃ©dito          â”‚
â”‚   â”‚   â””â”€â”€ {txId}: { date, amount, cardId, invoiceMonthKey, installments, ... }  â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â”œâ”€â”€ ğŸ”„ sync_status/pluggy          â† Status da sincronizaÃ§Ã£o em tempo real    â”‚
â”‚   â”‚   â””â”€â”€ { state, message, lastUpdated }                                        â”‚
â”‚   â”‚                                                                             â”‚
â”‚   â””â”€â”€ ğŸ”” notifications/              â† NotificaÃ§Ãµes do sistema                  â”‚
â”‚       â””â”€â”€ {notifId}: { type, title, message, date, read }                        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ğŸ“± FRONTEND REACT (UI)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  ğŸ”„ Listener em tempo real no sync_status                            â”‚      â”‚
â”‚   â”‚  â””â”€ Mostra toast/progress de sincronizaÃ§Ã£o                          â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â”‚  ğŸ“Š Dados atualizados automaticamente via Firestore listeners       â”‚      â”‚
â”‚   â”‚  â””â”€ TransaÃ§Ãµes, contas e cards atualizam sem refresh                â”‚      â”‚
â”‚   â”‚                                                                      â”‚      â”‚
â”‚   â”‚  ğŸ”” NotificaÃ§Ã£o aparece quando sync completa                         â”‚      â”‚
â”‚   â”‚  â””â”€ "SincronizaÃ§Ã£o concluÃ­da. X transaÃ§Ãµes processadas."            â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUXO DETALHADO POR GATILHO

### 1ï¸âƒ£ WEBHOOK (Tempo Real)

```
Pluggy detecta mudanÃ§a no banco  â”€â”€â–¶  Pluggy envia POST para nosso /webhook
                                           â”‚
                                           â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  router.post('/webhook')             â”‚
                              â”‚  â€¢ Eventos: item/updated,           â”‚
                              â”‚    transactions/created,            â”‚
                              â”‚    transactions/deleted             â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  syncItem(apiKey, itemId, userId)   â”‚
                              â”‚  1. updateSyncStatus('in_progress') â”‚
                              â”‚  2. Busca accounts da API           â”‚
                              â”‚  3. Busca transactions (12 meses)   â”‚
                              â”‚  4. Busca bills (cartÃ£o crÃ©dito)    â”‚
                              â”‚  5. Processa e salva no Firestore   â”‚
                              â”‚  6. updateSyncStatus('success')     â”‚
                              â”‚  7. addSystemNotification()         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2ï¸âƒ£ CRON JOB (DiÃ¡rio Ã s 00:00)

```
Vercel Cron (03:00 UTC = 00:00 BRT)  â”€â”€â–¶  GET /api/cron-sync
                                                â”‚
                                                â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Para cada usuÃ¡rio no Firestore:                             â”‚
               â”‚                                                              â”‚
               â”‚  1. Busca connectedAccounts do usuÃ¡rio                       â”‚
               â”‚  2. Filtra apenas contas com connectionMode: 'AUTO'          â”‚
               â”‚  3. Para cada itemId Ãºnico:                                  â”‚
               â”‚     a. fetchAccountsByItem(apiKey, itemId)                   â”‚
               â”‚     b. fetchTransactionsByAccount(apiKey, accountId)         â”‚
               â”‚     c. tryFetchBills(apiKey, accountId)                      â”‚
               â”‚     d. Processa e salva creditCardTransactions               â”‚
               â”‚  4. Envia notificaÃ§Ã£o de sucesso/erro                        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3ï¸âƒ£ TRIGGER MANUAL

```
UsuÃ¡rio clica "Sincronizar"  â”€â”€â–¶  POST /api/pluggy/trigger-sync
                                        â”‚
                                        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  1. updateSyncStatus('pending')   â”‚
                          â”‚  2. PATCH /items/{itemId}         â”‚
                          â”‚     (ForÃ§a Pluggy a atualizar)    â”‚
                          â”‚  3. Pluggy busca dados do banco   â”‚
                          â”‚  4. Pluggy envia webhook          â”‚
                          â”‚     â†’ Volta ao fluxo do webhook   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ FUNÃ‡Ã•ES PRINCIPAIS

### `api/pluggy.js`

| FunÃ§Ã£o | DescriÃ§Ã£o |
|--------|-----------|
| `getPluggyApiKey()` | ObtÃ©m/cacheia token de autenticaÃ§Ã£o (10min TTL) |
| `pluggyRequest()` | Wrapper para chamadas Ã  API Pluggy com retry em 401 |
| `syncItem()` | Sincroniza um item completo (contas + transaÃ§Ãµes + bills) |
| `updateSyncStatus()` | Atualiza status no Firestore (pending/in_progress/success/error) |
| `upsertTransaction()` | Insere ou atualiza transaÃ§Ã£o baseado no providerId |
| `addSystemNotification()` | Cria notificaÃ§Ã£o para o usuÃ¡rio |

### `api/cron-sync.js`

| FunÃ§Ã£o | DescriÃ§Ã£o |
|--------|-----------|
| `initFirebase()` | Inicializa Firebase Admin |
| `syncUserAccounts()` | Sincroniza todas as contas AUTO de um usuÃ¡rio |
| `fetchAccountsByItem()` | Busca todas as contas de um item (paginado) |
| `fetchTransactionsByAccount()` | Busca transaÃ§Ãµes de uma conta (12 meses) |
| `tryFetchBills()` | Tenta buscar faturas (mÃºltiplos endpoints) |
| `addNotification()` | Adiciona notificaÃ§Ã£o de conclusÃ£o |

---

## ğŸ”‘ VARIÃVEIS DE AMBIENTE NECESSÃRIAS

```env
PLUGGY_CLIENT_ID=xxx
PLUGGY_CLIENT_SECRET=xxx
PLUGGY_API_URL=https://api.pluggy.ai

# Firebase Admin (para server-side)
FIREBASE_SERVICE_ACCOUNT={"type":"service_account",...}
VITE_FIREBASE_PROJECT_ID=financeiro-609e1

# SeguranÃ§a do Cron (opcional)
CRON_SECRET=xxx
```

---

## ğŸ“Š COLLECTIONS NO FIRESTORE

| Collection | DescriÃ§Ã£o | Campos Principais |
|------------|-----------|-------------------|
| `accounts` | Contas corrente/poupanÃ§a | id, itemId, name, balance, type |
| `connectedAccounts` | CartÃµes de crÃ©dito | id, itemId, creditLimit, closingDay, bills[] |
| `transactions` | TransaÃ§Ãµes bancÃ¡rias | date, amount, category, providerId |
| `creditCardTransactions` | TransaÃ§Ãµes de cartÃ£o | date, amount, cardId, invoiceMonthKey |
| `sync_status` | Status da sincronizaÃ§Ã£o | state, message, lastUpdated |
| `notifications` | NotificaÃ§Ãµes do sistema | type, title, message, read |
